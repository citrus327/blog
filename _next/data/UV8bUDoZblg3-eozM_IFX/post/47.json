{"pageProps":{"html":"<h1 dir=\"auto\">WSL2中使用网络代理配置</h1>\n<h2 dir=\"auto\">背景</h2>\n<p dir=\"auto\">最近电脑升级了windows11且卸载了ubuntu系统，家里开发环境就顺带移步到WSL2。之前就听说wsl2的整体网络设计不同于wsl1非常麻烦，一直在逃避搞代理这回事儿。现在由于npm publish速度实在堪忧，设置代理这关是逃不掉了，前后折腾了2个小时总算搞明白了。在此记录。</p>\n<h2 dir=\"auto\">过程</h2>\n<ol dir=\"auto\">\n<li>关闭自动更新dns nameserver</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"#/etc/wsl.conf\n[network]\ngenerateResolvConf = false\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span>/etc/wsl.conf</span>\n[network]\ngenerateResolvConf = <span class=\"pl-c1\">false</span></pre></div>\n<ol start=\"2\" dir=\"auto\">\n<li>添加以下脚本至<code class=\"notranslate\">.bashrc</code>或<code class=\"notranslate\">.zshrc</code></li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# add for proxy\nexport hostip=$(ip route | grep default | awk '{print $3}')\nexport hostport=1011#根据代理IP自行填入\nalias proxy='\n    export HTTPS_PROXY=&quot;http://${hostip}:${hostport}&quot;;\n    export HTTP_PROXY=&quot;http://${hostip}:${hostport}&quot;;\n    export ALL_PROXY=&quot;http://${hostip}:${hostport}&quot;;\n    echo -e &quot;Acquire::http::Proxy \\&quot;http://${hostip}:${hostport}\\&quot;;&quot; | sudo tee -a /etc/apt/apt.conf.d/proxy.conf &gt; /dev/null;\n    echo -e &quot;Acquire::https::Proxy \\&quot;http://${hostip}:${hostport}\\&quot;;&quot; | sudo tee -a /etc/apt/apt.conf.d/proxy.conf &gt; /dev/null;\n'\nalias unproxy='\n    unset HTTPS_PROXY;\n    unset HTTP_PROXY;\n    unset ALL_PROXY;\n    sudo sed -i -e '/Acquire::http::Proxy/d' /etc/apt/apt.conf.d/proxy.conf;\n    sudo sed -i -e '/Acquire::https::Proxy/d' /etc/apt/apt.conf.d/proxy.conf;\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span> add for proxy</span>\n<span class=\"pl-k\">export</span> hostip=<span class=\"pl-s\"><span class=\"pl-pds\">$(</span>ip route <span class=\"pl-k\">|</span> grep default <span class=\"pl-k\">|</span> awk <span class=\"pl-s\"><span class=\"pl-pds\">'</span>{print $3}<span class=\"pl-pds\">'</span></span><span class=\"pl-pds\">)</span></span>\n<span class=\"pl-k\">export</span> hostport=1011#根据代理IP自行填入\n<span class=\"pl-c1\">alias</span> proxy=<span class=\"pl-s\"><span class=\"pl-pds\">'</span></span>\n<span class=\"pl-s\">    export HTTPS_PROXY=\"http://${hostip}:${hostport}\";</span>\n<span class=\"pl-s\">    export HTTP_PROXY=\"http://${hostip}:${hostport}\";</span>\n<span class=\"pl-s\">    export ALL_PROXY=\"http://${hostip}:${hostport}\";</span>\n<span class=\"pl-s\">    echo -e \"Acquire::http::Proxy \\\"http://${hostip}:${hostport}\\\";\" | sudo tee -a /etc/apt/apt.conf.d/proxy.conf &gt; /dev/null;</span>\n<span class=\"pl-s\">    echo -e \"Acquire::https::Proxy \\\"http://${hostip}:${hostport}\\\";\" | sudo tee -a /etc/apt/apt.conf.d/proxy.conf &gt; /dev/null;</span>\n<span class=\"pl-s\"><span class=\"pl-pds\">'</span></span>\n<span class=\"pl-c1\">alias</span> unproxy=<span class=\"pl-s\"><span class=\"pl-pds\">'</span></span>\n<span class=\"pl-s\">    unset HTTPS_PROXY;</span>\n<span class=\"pl-s\">    unset HTTP_PROXY;</span>\n<span class=\"pl-s\">    unset ALL_PROXY;</span>\n<span class=\"pl-s\">    sudo sed -i -e <span class=\"pl-pds\">'</span></span>/Acquire::http::Proxy/d<span class=\"pl-s\"><span class=\"pl-pds\">'</span> /etc/apt/apt.conf.d/proxy.conf;</span>\n<span class=\"pl-s\">    sudo sed -i -e <span class=\"pl-pds\">'</span></span>/Acquire::https::Proxy/d<span class=\"pl-s\"><span class=\"pl-pds\">'</span> /etc/apt/apt.conf.d/proxy.conf;</span></pre></div>\n<ol start=\"3\" dir=\"auto\">\n<li>\n<p dir=\"auto\">执行<code class=\"notranslate\">proxy</code>设置代理</p>\n</li>\n<li>\n<p dir=\"auto\">每次重启wsl后, /etc/resolv.conf中的内容会被重置，所以需要执行以下内容：</p>\n</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"#https://github.com/microsoft/WSL/issues/5420#issuecomment-646479747\nsudo rm /etc/resolv.conf\nsudo bash -c 'echo &quot;nameserver 8.8.8.8&quot; &gt; /etc/resolv.conf'\nsudo bash -c 'echo &quot;[network]&quot; &gt; /etc/wsl.conf'\nsudo bash -c 'echo &quot;generateResolvConf = false&quot; &gt;&gt; /etc/wsl.conf'\nsudo chattr +i /etc/resolv.conf\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span>https://github.com/microsoft/WSL/issues/5420#issuecomment-646479747</span>\nsudo rm /etc/resolv.conf\nsudo bash -c <span class=\"pl-s\"><span class=\"pl-pds\">'</span>echo \"nameserver 8.8.8.8\" &gt; /etc/resolv.conf<span class=\"pl-pds\">'</span></span>\nsudo bash -c <span class=\"pl-s\"><span class=\"pl-pds\">'</span>echo \"[network]\" &gt; /etc/wsl.conf<span class=\"pl-pds\">'</span></span>\nsudo bash -c <span class=\"pl-s\"><span class=\"pl-pds\">'</span>echo \"generateResolvConf = false\" &gt;&gt; /etc/wsl.conf<span class=\"pl-pds\">'</span></span>\nsudo chattr +i /etc/resolv.conf</pre></div>\n<ol start=\"5\" dir=\"auto\">\n<li>\n<p dir=\"auto\">为代理软件设置防火墙放行<br>\nwin11下通过<code class=\"notranslate\">防火墙和网络保护</code> - <code class=\"notranslate\">允许应用通过防火墙</code>，将v2ray（根据个人情况而定，我用得是v2ray）设置为放行<br>\n<a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/17166940/210820027-e460b728-486c-406c-afdb-4736c6be1a62.png\"><img src=\"https://user-images.githubusercontent.com/17166940/210820027-e460b728-486c-406c-afdb-4736c6be1a62.png\" alt=\"image\" style=\"max-width: 100%;\"></a><br>\n<a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/17166940/210820147-5853c0d6-8959-4dff-8727-0768a3c2a5b1.png\"><img src=\"https://user-images.githubusercontent.com/17166940/210820147-5853c0d6-8959-4dff-8727-0768a3c2a5b1.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n</li>\n<li>\n<p dir=\"auto\">v2ray设置允许局域网访问<br>\n<a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/17166940/210820283-500950c6-3ba0-43e0-8dfc-7b73655a46fd.png\"><img src=\"https://user-images.githubusercontent.com/17166940/210820283-500950c6-3ba0-43e0-8dfc-7b73655a46fd.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>\n</li>\n<li>\n<p dir=\"auto\">使用curl测试是否成功</p>\n</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"curl -vv google.com\"><pre class=\"notranslate\">curl -vv google.com</pre></div>\n<h2 dir=\"auto\">References</h2>\n<ul dir=\"auto\">\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"639648984\" data-permission-text=\"Title is private\" data-url=\"https://github.com/microsoft/WSL/issues/5420\" data-hovercard-type=\"issue\" data-hovercard-url=\"/microsoft/WSL/issues/5420/hovercard\" href=\"https://github.com/microsoft/WSL/issues/5420\">microsoft/WSL#5420</a></li>\n<li><a href=\"https://zhuanlan.zhihu.com/p/414627975\" rel=\"nofollow\">https://zhuanlan.zhihu.com/p/414627975</a></li>\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"892348001\" data-permission-text=\"Title is private\" data-url=\"https://github.com/2dust/v2rayN/issues/1573\" data-hovercard-type=\"issue\" data-hovercard-url=\"/2dust/v2rayN/issues/1573/hovercard\" href=\"https://github.com/2dust/v2rayN/issues/1573\">2dust/v2rayN#1573</a></li>\n<li><a href=\"https://jiayaoo3o.github.io/2020/06/23/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1WSL2%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/\" rel=\"nofollow\">https://jiayaoo3o.github.io/2020/06/23/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1WSL2%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/</a></li>\n</ul>\n<h2 dir=\"auto\">Troubleshooting</h2>\n<ol dir=\"auto\">\n<li>占位程序接收到错误数据 - 管理员权限下执行<code class=\"notranslate\">netsh winsock reset</code> 重启电脑解决。</li>\n</ol>"},"__N_SSG":true}