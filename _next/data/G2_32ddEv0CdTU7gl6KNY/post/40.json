{"pageProps":{"html":"<h1 dir=\"auto\">rollup打包 _export is not defined问题解决方案</h1>\n<h2 dir=\"auto\">Rollup 配置</h2>\n<div class=\"highlight highlight-source-js notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"import { babel } from &quot;@rollup/plugin-babel&quot;;\nimport commonjs from &quot;@rollup/plugin-commonjs&quot;;\nimport resolve from &quot;@rollup/plugin-node-resolve&quot;;\nimport url from &quot;@rollup/plugin-url&quot;;\nimport external from &quot;rollup-plugin-peer-deps-external&quot;;\nimport postcss from &quot;rollup-plugin-postcss&quot;;\nimport typescript from &quot;rollup-plugin-typescript&quot;;\nimport pkg from &quot;./package.json&quot;;\n\nconst config = {\n  input: &quot;src/index.ts&quot;,\n  output: [\n    {\n      file: pkg.main,\n      format: &quot;cjs&quot;,\n      exports: &quot;named&quot;,\n    },\n    {\n      file: pkg.module,\n      format: &quot;es&quot;,\n      exports: &quot;named&quot;,\n    },\n  ],\n  plugins: [\n    resolve(),\n    commonjs(),\n    postcss({\n      plugins: [],\n      minimize: true,\n    }),\n    external({\n      includeDependencies: false,\n    }),\n    babel({\n      babelHelpers: &quot;bundled&quot;,\n      presets: [\n        [\n          &quot;@babel/preset-env&quot;,\n          {\n            useBuiltIns: &quot;usage&quot;,\n            corejs: 3,\n          },\n        ],\n      ],\n    }),\n    url(),\n    typescript({ tsconfig: &quot;./tsconfig.json&quot; }),\n  ],\n};\n\nexport default config;\"><pre><span class=\"pl-k\">import</span> <span class=\"pl-kos\">{</span> <span class=\"pl-s1\">babel</span> <span class=\"pl-kos\">}</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"@rollup/plugin-babel\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">commonjs</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"@rollup/plugin-commonjs\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">resolve</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"@rollup/plugin-node-resolve\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">url</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"@rollup/plugin-url\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">external</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"rollup-plugin-peer-deps-external\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">postcss</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"rollup-plugin-postcss\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">typescript</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"rollup-plugin-typescript\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-k\">import</span> <span class=\"pl-s1\">pkg</span> <span class=\"pl-k\">from</span> <span class=\"pl-s\">\"./package.json\"</span><span class=\"pl-kos\">;</span>\n\n<span class=\"pl-k\">const</span> <span class=\"pl-s1\">config</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">{</span>\n  <span class=\"pl-c1\">input</span>: <span class=\"pl-s\">\"src/index.ts\"</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-c1\">output</span>: <span class=\"pl-kos\">[</span>\n    <span class=\"pl-kos\">{</span>\n      <span class=\"pl-c1\">file</span>: <span class=\"pl-s1\">pkg</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">main</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-c1\">format</span>: <span class=\"pl-s\">\"cjs\"</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-c1\">exports</span>: <span class=\"pl-s\">\"named\"</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">{</span>\n      <span class=\"pl-c1\">file</span>: <span class=\"pl-s1\">pkg</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">module</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-c1\">format</span>: <span class=\"pl-s\">\"es\"</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-c1\">exports</span>: <span class=\"pl-s\">\"named\"</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-c1\">plugins</span>: <span class=\"pl-kos\">[</span>\n    <span class=\"pl-en\">resolve</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-en\">commonjs</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-en\">postcss</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n      <span class=\"pl-c1\">plugins</span>: <span class=\"pl-kos\">[</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-c1\">minimize</span>: <span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-en\">external</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n      <span class=\"pl-c1\">includeDependencies</span>: <span class=\"pl-c1\">false</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-en\">babel</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n      <span class=\"pl-c1\">babelHelpers</span>: <span class=\"pl-s\">\"bundled\"</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-c1\">presets</span>: <span class=\"pl-kos\">[</span>\n        <span class=\"pl-kos\">[</span>\n          <span class=\"pl-s\">\"@babel/preset-env\"</span><span class=\"pl-kos\">,</span>\n          <span class=\"pl-kos\">{</span>\n            <span class=\"pl-c1\">useBuiltIns</span>: <span class=\"pl-s\">\"usage\"</span><span class=\"pl-kos\">,</span>\n            <span class=\"pl-c1\">corejs</span>: <span class=\"pl-c1\">3</span><span class=\"pl-kos\">,</span>\n          <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n        <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-en\">url</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-en\">typescript</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span> <span class=\"pl-c1\">tsconfig</span>: <span class=\"pl-s\">\"./tsconfig.json\"</span> <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-kos\">}</span><span class=\"pl-kos\">;</span>\n\n<span class=\"pl-k\">export</span> <span class=\"pl-k\">default</span> <span class=\"pl-s1\">config</span><span class=\"pl-kos\">;</span></pre></div>\n<h2 dir=\"auto\">问题</h2>\n<p dir=\"auto\">报出 <code class=\"notranslate\">$$1w is not defined</code>，实际查证是$$1w指向了<code class=\"notranslate\">_export</code>这个方法。而<code class=\"notranslate\">_export</code>的定义在最下方。</p>\n<h2 dir=\"auto\">原因</h2>\n<p dir=\"auto\">根据以下Issue</p>\n<ol dir=\"auto\">\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"642758941\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rollup/plugins/issues/466\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rollup/plugins/issues/466/hovercard\" href=\"https://github.com/rollup/plugins/issues/466\">rollup/plugins#466</a></li>\n<li><a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"712450081\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rollup/rollup/issues/3802\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rollup/rollup/issues/3802/hovercard\" href=\"https://github.com/rollup/rollup/issues/3802\">rollup/rollup#3802</a></li>\n</ol>\n<p dir=\"auto\">原因是当打包dependencies时，core-js本身会被babel再解析一遍，造成循环引用。</p>\n<p dir=\"auto\">Quote:</p>\n<blockquote>\n<p dir=\"auto\">You need to exclude core-js from babel or @babel/preset-env with useBuiltins: 'usage' will create a circular reference trying to process core-js itself:</p>\n</blockquote>\n<h2 dir=\"auto\">解决方案</h2>\n<ol dir=\"auto\">\n<li>external插件配置<code class=\"notranslate\">includeDependencies: true</code>, 产物不打包core-js</li>\n<li>babel插件exclude core-js</li>\n</ol>\n<h2 dir=\"auto\">结果</h2>\n<div class=\"highlight highlight-source-js notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"external({\n  includeDependencies: false,\n}),\nbabel({\n  babelHelpers: &quot;bundled&quot;,\n  exclude: [/core-js/],\n  presets: [\n    [\n      &quot;@babel/preset-env&quot;,\n      {\n        useBuiltIns: &quot;usage&quot;,\n        corejs: 3,\n      },\n    ],\n  ],\n})\"><pre><span class=\"pl-en\">external</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n  <span class=\"pl-c1\">includeDependencies</span>: <span class=\"pl-c1\">false</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-en\">babel</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n  <span class=\"pl-c1\">babelHelpers</span>: <span class=\"pl-s\">\"bundled\"</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-c1\">exclude</span>: <span class=\"pl-kos\">[</span><span class=\"pl-pds\"><span class=\"pl-c1\">/</span>core-js<span class=\"pl-c1\">/</span></span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-c1\">presets</span>: <span class=\"pl-kos\">[</span>\n    <span class=\"pl-kos\">[</span>\n      <span class=\"pl-s\">\"@babel/preset-env\"</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-kos\">{</span>\n        <span class=\"pl-c1\">useBuiltIns</span>: <span class=\"pl-s\">\"usage\"</span><span class=\"pl-kos\">,</span>\n        <span class=\"pl-c1\">corejs</span>: <span class=\"pl-c1\">3</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span></pre></div>\n<p dir=\"auto\">或者</p>\n<div class=\"highlight highlight-source-js notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"external({\n  includeDependencies: true,\n}),\nbabel({\n  babelHelpers: &quot;bundled&quot;,\n  presets: [\n    [\n      &quot;@babel/preset-env&quot;,\n      {\n        useBuiltIns: &quot;usage&quot;,\n        corejs: 3,\n      },\n    ],\n  ],\n})\"><pre><span class=\"pl-en\">external</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n  <span class=\"pl-c1\">includeDependencies</span>: <span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-en\">babel</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">{</span>\n  <span class=\"pl-c1\">babelHelpers</span>: <span class=\"pl-s\">\"bundled\"</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-c1\">presets</span>: <span class=\"pl-kos\">[</span>\n    <span class=\"pl-kos\">[</span>\n      <span class=\"pl-s\">\"@babel/preset-env\"</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-kos\">{</span>\n        <span class=\"pl-c1\">useBuiltIns</span>: <span class=\"pl-s\">\"usage\"</span><span class=\"pl-kos\">,</span>\n        <span class=\"pl-c1\">corejs</span>: <span class=\"pl-c1\">3</span><span class=\"pl-kos\">,</span>\n      <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span>\n    <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n  <span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span>\n<span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span></pre></div>"},"__N_SSG":true}