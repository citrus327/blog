<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Minimal Life</title><meta name="description" content="Minimal Life Blog"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><link rel="preload" href="/blog/_next/static/css/6db3845f9f3a867b.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/6db3845f9f3a867b.css" data-n-g=""/><link rel="preload" href="/blog/_next/static/css/452f28fbf231f2d9.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/452f28fbf231f2d9.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/blog/_next/static/chunks/webpack-4d5208940e01a3dc.js" defer=""></script><script src="/blog/_next/static/chunks/framework-00b57966872fc495.js" defer=""></script><script src="/blog/_next/static/chunks/main-04fa69cd18d105e9.js" defer=""></script><script src="/blog/_next/static/chunks/pages/_app-f55443f2448c8e66.js" defer=""></script><script src="/blog/_next/static/chunks/247-b84c2316c963d09c.js" defer=""></script><script src="/blog/_next/static/chunks/pages/post/%5Bid%5D-5f7ac47925745e56.js" defer=""></script><script src="/blog/_next/static/qyoq5YUbT8vkn4SeD-glR/_buildManifest.js" defer=""></script><script src="/blog/_next/static/qyoq5YUbT8vkn4SeD-glR/_ssgManifest.js" defer=""></script><script src="/blog/_next/static/qyoq5YUbT8vkn4SeD-glR/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><div class="Layout_container__KdNo5"><header class="Layout_header__TY1Ur"><div class="Avatar_avatar__Wqsgs"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2724%27%20height=%2724%27/%3e"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="Avatar_img__fPm7S" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" srcSet="https://avatars.githubusercontent.com/u/17166940?v=4 1x, https://avatars.githubusercontent.com/u/17166940?v=4 2x" src="https://avatars.githubusercontent.com/u/17166940?v=4" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="Avatar_img__fPm7S" loading="lazy"/></noscript></span><div class="Avatar_username__94Fmm">phshy0607</div></div><div class="Navbar_navbar__dE_dF"><nav class="Navbar_nav__lgcdH"><a href="/blog">Home</a></nav><nav class="Navbar_nav__lgcdH"><a href="/blog/posts">Posts</a></nav></div></header><main class="Layout_main__CO5d2"><div class="markdown-body"><h1 dir="auto">使用rollup构建library的一次尝试</h1>
<blockquote>
<p dir="auto">因为在设计博客和CMS的时候，有一个设想就是在CMS里去编辑md，同时实时预览，这个预览和实际提交在博客上展示要求完全一致。所以就想着自己弄一个预览模块，在两个项目之前共享代码。这就涉及到一个Markdown Preview的工具。这个工具其实就是从MD =&gt; HTML，使用highlight.js做代码高亮，一些自定义的配置和样式文件，然后打包成一个js包。</p>
<p dir="auto">这个打包环节其实是想用webpack打一个umd的包就得了，但是一直知道有个rollup的工具存在，非常轻量，同时Vue.js也是通过rollup打包的，所以就想做出一次尝试。以下是阅读文档，结合awesome rollup仓库总结的一些经验。</p>
<p dir="auto">同时本文只会涉及到一些rollup相关的，关于markdown处理会再开一篇文章记录。</p>
</blockquote>
<h2 dir="auto">起步</h2>
<p dir="auto"><a href="https://github.com/rollup/rollup">rollup github地址</a></p>
<p dir="auto"><a href="https://rollupjs.org/guide/en/" rel="nofollow">官方文档</a></p>
<p dir="auto"><a href="https://github.com/rollup/rollup-starter-lib">官方提供的构建library的模板</a></p>
<p dir="auto"><a href="https://github.com/rollup/awesome">awesome-rollup</a></p>
<p dir="auto"><a href="https://github.com/phshy0607/markdown-preview">本文涉及到的源码</a></p>
<h2 dir="auto">package.json</h2>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="{
  &quot;name&quot;: &quot;my-package&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;main&quot;: &quot;dist/my-package.js&quot;
}"><pre>{
  <span class="pl-ent">"name"</span>: <span class="pl-s"><span class="pl-pds">"</span>my-package<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"version"</span>: <span class="pl-s"><span class="pl-pds">"</span>0.1.0<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"main"</span>: <span class="pl-s"><span class="pl-pds">"</span>dist/my-package.js<span class="pl-pds">"</span></span>
}</pre></div>
<p dir="auto">通常，包内的package.json通常用有一个叫main的属性，他说明的是本包的内容是在<code class="notranslate">dist/my-package.js</code>中。</p>
<p dir="auto">像Webpack, Browserify之类的bundler会解析这个main, 然后引入main属性对应的js，同时根据dependencies去载入相应依赖。<br>
在第三方打包时一般都会优先选用umd的包，因为这样浏览器也可以使用，所以一般第三方的lib的main属性通常都是umd的包。</p>
<p dir="auto">而rollup属于ES2015-aware的工具，在rollup内使用CJS或者UMD并不是最理想的情况，因为无法使用ES6 module的特性。<br>
如果对方在使用rollup作为他的bundler, 而也说了rollup属于ES2015-aware的工具，他会优先读取package.json里的module属性，如果没有，才会读main属性，这样既可以保证一般bundler可以正常解析文件，同时在使用rollup的时候会优先读取module里的es包。</p>
<p dir="auto">所以package.json就会变成：</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="{
  &quot;name&quot;: &quot;my-package&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;main&quot;: &quot;dist/my-package.umd.js&quot;,
  &quot;module&quot;: &quot;dist/my-package.esm.js&quot;
}"><pre>{
  <span class="pl-ent">"name"</span>: <span class="pl-s"><span class="pl-pds">"</span>my-package<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"version"</span>: <span class="pl-s"><span class="pl-pds">"</span>0.1.0<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"main"</span>: <span class="pl-s"><span class="pl-pds">"</span>dist/my-package.umd.js<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"module"</span>: <span class="pl-s"><span class="pl-pds">"</span>dist/my-package.esm.js<span class="pl-pds">"</span></span>
}</pre></div>
<p dir="auto">这对于打出的包来说属于双赢。<br>
具体可以查看<a href="https://github.com/rollup/rollup/wiki/pkg.module">官方对于这种做法的解释</a></p>
<h2 dir="auto">配置文件</h2>
<p dir="auto"><a href="https://rollupjs.org/guide/en/#configuration-files" rel="nofollow">配置文件详细文档</a></p>
<blockquote>
<p dir="auto">rollup的配置文件可以使用es6语法编写<br>
使用-c来指定config文件，默认读取根目录下rollup.config.js</p>
</blockquote>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="  rollup -c
  rollup --config
  rollup -c build/rollup.config.js"><pre>  rollup -c
  rollup --config
  rollup -c build/rollup.config.js</pre></div>
<p dir="auto">这里也放出我用的配置文件</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="import resolve from '@rollup/plugin-node-resolve'
import commonjs from 'rollup-plugin-commonjs'
import pkg from './package.json'
import dev from 'rollup-plugin-dev'
import postcss from 'rollup-plugin-postcss'
import { string } from &quot;rollup-plugin-string&quot;
import { terser } from 'rollup-plugin-terser'

const devServerConfig = {
  port: 3000
}

const plugins = function (format) {
  const commonPlugins = [
    dev(devServerConfig),
    postcss({
      extract: false
    }),
    string({
      include: &quot;**/*.md&quot;,
    }),
    terser()
  ]
  if (format === 'umd') {
    return [
      ...commonPlugins,
      resolve(),
      commonjs(),
    ]
  } else {
    return commonPlugins
  }
}

export default [
  // for browser
  {
    input: 'src/index.js',
    output: {
      name: 'MarkdownPreview',
      file: pkg.browser,
      format: 'umd'
    },
    plugins: plugins('umd')
  },

  // for cjs and esm
  {
    input: 'src/index.js',
    external: Object.keys(pkg.dependencies),
    output: [
      {file: pkg.main, format: 'cjs'},
      {file: pkg.module, format: 'es'},
    ],
    plugins: plugins()
  }
]"><pre><span class="pl-k">import</span> <span class="pl-s1">resolve</span> <span class="pl-k">from</span> <span class="pl-s">'@rollup/plugin-node-resolve'</span>
<span class="pl-k">import</span> <span class="pl-s1">commonjs</span> <span class="pl-k">from</span> <span class="pl-s">'rollup-plugin-commonjs'</span>
<span class="pl-k">import</span> <span class="pl-s1">pkg</span> <span class="pl-k">from</span> <span class="pl-s">'./package.json'</span>
<span class="pl-k">import</span> <span class="pl-s1">dev</span> <span class="pl-k">from</span> <span class="pl-s">'rollup-plugin-dev'</span>
<span class="pl-k">import</span> <span class="pl-s1">postcss</span> <span class="pl-k">from</span> <span class="pl-s">'rollup-plugin-postcss'</span>
<span class="pl-k">import</span> <span class="pl-kos">{</span> <span class="pl-s1">string</span> <span class="pl-kos">}</span> <span class="pl-k">from</span> <span class="pl-s">"rollup-plugin-string"</span>
<span class="pl-k">import</span> <span class="pl-kos">{</span> <span class="pl-s1">terser</span> <span class="pl-kos">}</span> <span class="pl-k">from</span> <span class="pl-s">'rollup-plugin-terser'</span>

<span class="pl-k">const</span> <span class="pl-s1">devServerConfig</span> <span class="pl-c1">=</span> <span class="pl-kos">{</span>
  <span class="pl-c1">port</span>: <span class="pl-c1">3000</span>
<span class="pl-kos">}</span>

<span class="pl-k">const</span> <span class="pl-en">plugins</span> <span class="pl-c1">=</span> <span class="pl-k">function</span> <span class="pl-kos">(</span><span class="pl-s1">format</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
  <span class="pl-k">const</span> <span class="pl-s1">commonPlugins</span> <span class="pl-c1">=</span> <span class="pl-kos">[</span>
    <span class="pl-en">dev</span><span class="pl-kos">(</span><span class="pl-s1">devServerConfig</span><span class="pl-kos">)</span><span class="pl-kos">,</span>
    <span class="pl-en">postcss</span><span class="pl-kos">(</span><span class="pl-kos">{</span>
      <span class="pl-c1">extract</span>: <span class="pl-c1">false</span>
    <span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">,</span>
    <span class="pl-en">string</span><span class="pl-kos">(</span><span class="pl-kos">{</span>
      <span class="pl-c1">include</span>: <span class="pl-s">"**/*.md"</span><span class="pl-kos">,</span>
    <span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">,</span>
    <span class="pl-en">terser</span><span class="pl-kos">(</span><span class="pl-kos">)</span>
  <span class="pl-kos">]</span>
  <span class="pl-k">if</span> <span class="pl-kos">(</span><span class="pl-s1">format</span> <span class="pl-c1">===</span> <span class="pl-s">'umd'</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
    <span class="pl-k">return</span> <span class="pl-kos">[</span>
      ...<span class="pl-s1">commonPlugins</span><span class="pl-kos">,</span>
      <span class="pl-en">resolve</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">,</span>
      <span class="pl-en">commonjs</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">,</span>
    <span class="pl-kos">]</span>
  <span class="pl-kos">}</span> <span class="pl-k">else</span> <span class="pl-kos">{</span>
    <span class="pl-k">return</span> <span class="pl-s1">commonPlugins</span>
  <span class="pl-kos">}</span>
<span class="pl-kos">}</span>

<span class="pl-k">export</span> <span class="pl-k">default</span> <span class="pl-kos">[</span>
  <span class="pl-c">// for browser</span>
  <span class="pl-kos">{</span>
    <span class="pl-c1">input</span>: <span class="pl-s">'src/index.js'</span><span class="pl-kos">,</span>
    <span class="pl-c1">output</span>: <span class="pl-kos">{</span>
      <span class="pl-c1">name</span>: <span class="pl-s">'MarkdownPreview'</span><span class="pl-kos">,</span>
      <span class="pl-c1">file</span>: <span class="pl-s1">pkg</span><span class="pl-kos">.</span><span class="pl-c1">browser</span><span class="pl-kos">,</span>
      <span class="pl-c1">format</span>: <span class="pl-s">'umd'</span>
    <span class="pl-kos">}</span><span class="pl-kos">,</span>
    <span class="pl-c1">plugins</span>: <span class="pl-en">plugins</span><span class="pl-kos">(</span><span class="pl-s">'umd'</span><span class="pl-kos">)</span>
  <span class="pl-kos">}</span><span class="pl-kos">,</span>

  <span class="pl-c">// for cjs and esm</span>
  <span class="pl-kos">{</span>
    <span class="pl-c1">input</span>: <span class="pl-s">'src/index.js'</span><span class="pl-kos">,</span>
    <span class="pl-c1">external</span>: <span class="pl-v">Object</span><span class="pl-kos">.</span><span class="pl-en">keys</span><span class="pl-kos">(</span><span class="pl-s1">pkg</span><span class="pl-kos">.</span><span class="pl-c1">dependencies</span><span class="pl-kos">)</span><span class="pl-kos">,</span>
    <span class="pl-c1">output</span>: <span class="pl-kos">[</span>
      <span class="pl-kos">{</span><span class="pl-c1">file</span>: <span class="pl-s1">pkg</span><span class="pl-kos">.</span><span class="pl-c1">main</span><span class="pl-kos">,</span> <span class="pl-c1">format</span>: <span class="pl-s">'cjs'</span><span class="pl-kos">}</span><span class="pl-kos">,</span>
      <span class="pl-kos">{</span><span class="pl-c1">file</span>: <span class="pl-s1">pkg</span><span class="pl-kos">.</span><span class="pl-c1">module</span><span class="pl-kos">,</span> <span class="pl-c1">format</span>: <span class="pl-s">'es'</span><span class="pl-kos">}</span><span class="pl-kos">,</span>
    <span class="pl-kos">]</span><span class="pl-kos">,</span>
    <span class="pl-c1">plugins</span>: <span class="pl-en">plugins</span><span class="pl-kos">(</span><span class="pl-kos">)</span>
  <span class="pl-kos">}</span>
<span class="pl-kos">]</span></pre></div>
<h2 dir="auto">常用依赖</h2>
<ol dir="auto">
<li><a href="https://github.com/rollup/rollup-plugin-commonjs">rollup-plugin-commonjs</a><br>
支持解析commonjs包至es6 module</li>
<li><a href="https://github.com/rollup/plugins/tree/master/packages/node-resolve">@rollup/plugin-node-resolve</a><br>
支持解析node_modules里的包 之前的包<a href="https://github.com/rollup/rollup-plugin-node-resolve">rollup-plugin-node-resolve</a>已经archive了且不再维护</li>
<li><a href="https://github.com/vuejs/rollup-plugin-vue">rollup-plugin-vue</a></li>
<li><a href="https://github.com/konsumer/rollup-plugin-jsx">rollup-plugin-jsx</a></li>
<li><a href="https://github.com/xiaofuzi/rollup-plugin-md">rollup-plugin-md</a></li>
<li><a href="https://github.com/TrySound/rollup-plugin-terser">rollup-plugin-terser</a></li>
<li><a href="https://github.com/TrySound/rollup-plugin-string">rollup-plugin-string</a></li>
</ol>
<h2 dir="auto">坑</h2>
<ol dir="auto">
<li><a href="https://github.com/TrySound/rollup-plugin-uglify">rollup-plugin-uglify</a><br>
因为之前没有用过<a href="https://github.com/terser/terser">terser</a>作为minify的工具，所以选择了rollup-plugin-uglify<br>
打包esm的时候竟然不支持es6语法。terser官方也说了这个问题，</li>
</ol>
<blockquote>
<p dir="auto">Why choose terser?<br>
uglify-es is no longer maintained and uglify-js does not support ES6+.<br>
terser is a fork of uglify-es that mostly retains API and CLI compatibility with uglify-es and uglify-js@3.</p>
</blockquote>
<p dir="auto">所以使用rollup-plugin-terser作为minify工具。</p></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"html":"\u003ch1 dir=\"auto\"\u003e使用rollup构建library的一次尝试\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp dir=\"auto\"\u003e因为在设计博客和CMS的时候，有一个设想就是在CMS里去编辑md，同时实时预览，这个预览和实际提交在博客上展示要求完全一致。所以就想着自己弄一个预览模块，在两个项目之前共享代码。这就涉及到一个Markdown Preview的工具。这个工具其实就是从MD =\u0026gt; HTML，使用highlight.js做代码高亮，一些自定义的配置和样式文件，然后打包成一个js包。\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e这个打包环节其实是想用webpack打一个umd的包就得了，但是一直知道有个rollup的工具存在，非常轻量，同时Vue.js也是通过rollup打包的，所以就想做出一次尝试。以下是阅读文档，结合awesome rollup仓库总结的一些经验。\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e同时本文只会涉及到一些rollup相关的，关于markdown处理会再开一篇文章记录。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 dir=\"auto\"\u003e起步\u003c/h2\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://github.com/rollup/rollup\"\u003erollup github地址\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://rollupjs.org/guide/en/\" rel=\"nofollow\"\u003e官方文档\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://github.com/rollup/rollup-starter-lib\"\u003e官方提供的构建library的模板\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://github.com/rollup/awesome\"\u003eawesome-rollup\u003c/a\u003e\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://github.com/phshy0607/markdown-preview\"\u003e本文涉及到的源码\u003c/a\u003e\u003c/p\u003e\n\u003ch2 dir=\"auto\"\u003epackage.json\u003c/h2\u003e\n\u003cdiv class=\"highlight highlight-source-json notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"{\n  \u0026quot;name\u0026quot;: \u0026quot;my-package\u0026quot;,\n  \u0026quot;version\u0026quot;: \u0026quot;0.1.0\u0026quot;,\n  \u0026quot;main\u0026quot;: \u0026quot;dist/my-package.js\u0026quot;\n}\"\u003e\u003cpre\u003e{\n  \u003cspan class=\"pl-ent\"\u003e\"name\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003emy-package\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n  \u003cspan class=\"pl-ent\"\u003e\"version\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e0.1.0\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n  \u003cspan class=\"pl-ent\"\u003e\"main\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003edist/my-package.js\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e通常，包内的package.json通常用有一个叫main的属性，他说明的是本包的内容是在\u003ccode class=\"notranslate\"\u003edist/my-package.js\u003c/code\u003e中。\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e像Webpack, Browserify之类的bundler会解析这个main, 然后引入main属性对应的js，同时根据dependencies去载入相应依赖。\u003cbr\u003e\n在第三方打包时一般都会优先选用umd的包，因为这样浏览器也可以使用，所以一般第三方的lib的main属性通常都是umd的包。\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e而rollup属于ES2015-aware的工具，在rollup内使用CJS或者UMD并不是最理想的情况，因为无法使用ES6 module的特性。\u003cbr\u003e\n如果对方在使用rollup作为他的bundler, 而也说了rollup属于ES2015-aware的工具，他会优先读取package.json里的module属性，如果没有，才会读main属性，这样既可以保证一般bundler可以正常解析文件，同时在使用rollup的时候会优先读取module里的es包。\u003c/p\u003e\n\u003cp dir=\"auto\"\u003e所以package.json就会变成：\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-json notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"{\n  \u0026quot;name\u0026quot;: \u0026quot;my-package\u0026quot;,\n  \u0026quot;version\u0026quot;: \u0026quot;0.1.0\u0026quot;,\n  \u0026quot;main\u0026quot;: \u0026quot;dist/my-package.umd.js\u0026quot;,\n  \u0026quot;module\u0026quot;: \u0026quot;dist/my-package.esm.js\u0026quot;\n}\"\u003e\u003cpre\u003e{\n  \u003cspan class=\"pl-ent\"\u003e\"name\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003emy-package\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n  \u003cspan class=\"pl-ent\"\u003e\"version\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e0.1.0\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n  \u003cspan class=\"pl-ent\"\u003e\"main\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003edist/my-package.umd.js\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e,\n  \u003cspan class=\"pl-ent\"\u003e\"module\"\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003edist/my-package.esm.js\u003cspan class=\"pl-pds\"\u003e\"\u003c/span\u003e\u003c/span\u003e\n}\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e这对于打出的包来说属于双赢。\u003cbr\u003e\n具体可以查看\u003ca href=\"https://github.com/rollup/rollup/wiki/pkg.module\"\u003e官方对于这种做法的解释\u003c/a\u003e\u003c/p\u003e\n\u003ch2 dir=\"auto\"\u003e配置文件\u003c/h2\u003e\n\u003cp dir=\"auto\"\u003e\u003ca href=\"https://rollupjs.org/guide/en/#configuration-files\" rel=\"nofollow\"\u003e配置文件详细文档\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp dir=\"auto\"\u003erollup的配置文件可以使用es6语法编写\u003cbr\u003e\n使用-c来指定config文件，默认读取根目录下rollup.config.js\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  rollup -c\n  rollup --config\n  rollup -c build/rollup.config.js\"\u003e\u003cpre\u003e  rollup -c\n  rollup --config\n  rollup -c build/rollup.config.js\u003c/pre\u003e\u003c/div\u003e\n\u003cp dir=\"auto\"\u003e这里也放出我用的配置文件\u003c/p\u003e\n\u003cdiv class=\"highlight highlight-source-js notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"import resolve from '@rollup/plugin-node-resolve'\nimport commonjs from 'rollup-plugin-commonjs'\nimport pkg from './package.json'\nimport dev from 'rollup-plugin-dev'\nimport postcss from 'rollup-plugin-postcss'\nimport { string } from \u0026quot;rollup-plugin-string\u0026quot;\nimport { terser } from 'rollup-plugin-terser'\n\nconst devServerConfig = {\n  port: 3000\n}\n\nconst plugins = function (format) {\n  const commonPlugins = [\n    dev(devServerConfig),\n    postcss({\n      extract: false\n    }),\n    string({\n      include: \u0026quot;**/*.md\u0026quot;,\n    }),\n    terser()\n  ]\n  if (format === 'umd') {\n    return [\n      ...commonPlugins,\n      resolve(),\n      commonjs(),\n    ]\n  } else {\n    return commonPlugins\n  }\n}\n\nexport default [\n  // for browser\n  {\n    input: 'src/index.js',\n    output: {\n      name: 'MarkdownPreview',\n      file: pkg.browser,\n      format: 'umd'\n    },\n    plugins: plugins('umd')\n  },\n\n  // for cjs and esm\n  {\n    input: 'src/index.js',\n    external: Object.keys(pkg.dependencies),\n    output: [\n      {file: pkg.main, format: 'cjs'},\n      {file: pkg.module, format: 'es'},\n    ],\n    plugins: plugins()\n  }\n]\"\u003e\u003cpre\u003e\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003eresolve\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'@rollup/plugin-node-resolve'\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003ecommonjs\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'rollup-plugin-commonjs'\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003epkg\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'./package.json'\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003edev\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'rollup-plugin-dev'\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003epostcss\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'rollup-plugin-postcss'\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003estring\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e\"rollup-plugin-string\"\u003c/span\u003e\n\u003cspan class=\"pl-k\"\u003eimport\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003eterser\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efrom\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'rollup-plugin-terser'\u003c/span\u003e\n\n\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003edevServerConfig\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"pl-c1\"\u003eport\u003c/span\u003e: \u003cspan class=\"pl-c1\"\u003e3000\u003c/span\u003e\n\u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-en\"\u003eplugins\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-k\"\u003efunction\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s1\"\u003eformat\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"pl-k\"\u003econst\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003ecommonPlugins\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e=\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"pl-en\"\u003edev\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s1\"\u003edevServerConfig\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-en\"\u003epostcss\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"pl-c1\"\u003eextract\u003c/span\u003e: \u003cspan class=\"pl-c1\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-en\"\u003estring\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"pl-c1\"\u003einclude\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e\"**/*.md\"\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-en\"\u003eterser\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"pl-k\"\u003eif\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s1\"\u003eformat\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003e===\u003c/span\u003e \u003cspan class=\"pl-s\"\u003e'umd'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e[\u003c/span\u003e\n      ...\u003cspan class=\"pl-s1\"\u003ecommonPlugins\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"pl-en\"\u003eresolve\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"pl-en\"\u003ecommonjs\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-kos\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e \u003cspan class=\"pl-k\"\u003eelse\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"pl-k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"pl-s1\"\u003ecommonPlugins\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"pl-k\"\u003eexport\u003c/span\u003e \u003cspan class=\"pl-k\"\u003edefault\u003c/span\u003e \u003cspan class=\"pl-kos\"\u003e[\u003c/span\u003e\n  \u003cspan class=\"pl-c\"\u003e// for browser\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003einput\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e'src/index.js'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003eoutput\u003c/span\u003e: \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"pl-c1\"\u003ename\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e'MarkdownPreview'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"pl-c1\"\u003efile\u003c/span\u003e: \u003cspan class=\"pl-s1\"\u003epkg\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e.\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003ebrowser\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"pl-c1\"\u003eformat\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e'umd'\u003c/span\u003e\n    \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003eplugins\u003c/span\u003e: \u003cspan class=\"pl-en\"\u003eplugins\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s\"\u003e'umd'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n\n  \u003cspan class=\"pl-c\"\u003e// for cjs and esm\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003einput\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e'src/index.js'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003eexternal\u003c/span\u003e: \u003cspan class=\"pl-v\"\u003eObject\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e.\u003c/span\u003e\u003cspan class=\"pl-en\"\u003ekeys\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-s1\"\u003epkg\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e.\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003edependencies\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003eoutput\u003c/span\u003e: \u003cspan class=\"pl-kos\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003efile\u003c/span\u003e: \u003cspan class=\"pl-s1\"\u003epkg\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e.\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003emain\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eformat\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e'cjs'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"pl-kos\"\u003e{\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003efile\u003c/span\u003e: \u003cspan class=\"pl-s1\"\u003epkg\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e.\u003c/span\u003e\u003cspan class=\"pl-c1\"\u003emodule\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e \u003cspan class=\"pl-c1\"\u003eformat\u003c/span\u003e: \u003cspan class=\"pl-s\"\u003e'es'\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-kos\"\u003e]\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"pl-c1\"\u003eplugins\u003c/span\u003e: \u003cspan class=\"pl-en\"\u003eplugins\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e(\u003c/span\u003e\u003cspan class=\"pl-kos\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"pl-kos\"\u003e}\u003c/span\u003e\n\u003cspan class=\"pl-kos\"\u003e]\u003c/span\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 dir=\"auto\"\u003e常用依赖\u003c/h2\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/rollup/rollup-plugin-commonjs\"\u003erollup-plugin-commonjs\u003c/a\u003e\u003cbr\u003e\n支持解析commonjs包至es6 module\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/rollup/plugins/tree/master/packages/node-resolve\"\u003e@rollup/plugin-node-resolve\u003c/a\u003e\u003cbr\u003e\n支持解析node_modules里的包 之前的包\u003ca href=\"https://github.com/rollup/rollup-plugin-node-resolve\"\u003erollup-plugin-node-resolve\u003c/a\u003e已经archive了且不再维护\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/vuejs/rollup-plugin-vue\"\u003erollup-plugin-vue\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/konsumer/rollup-plugin-jsx\"\u003erollup-plugin-jsx\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/xiaofuzi/rollup-plugin-md\"\u003erollup-plugin-md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/TrySound/rollup-plugin-terser\"\u003erollup-plugin-terser\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/TrySound/rollup-plugin-string\"\u003erollup-plugin-string\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 dir=\"auto\"\u003e坑\u003c/h2\u003e\n\u003col dir=\"auto\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/TrySound/rollup-plugin-uglify\"\u003erollup-plugin-uglify\u003c/a\u003e\u003cbr\u003e\n因为之前没有用过\u003ca href=\"https://github.com/terser/terser\"\u003eterser\u003c/a\u003e作为minify的工具，所以选择了rollup-plugin-uglify\u003cbr\u003e\n打包esm的时候竟然不支持es6语法。terser官方也说了这个问题，\u003c/li\u003e\n\u003c/ol\u003e\n\u003cblockquote\u003e\n\u003cp dir=\"auto\"\u003eWhy choose terser?\u003cbr\u003e\nuglify-es is no longer maintained and uglify-js does not support ES6+.\u003cbr\u003e\nterser is a fork of uglify-es that mostly retains API and CLI compatibility with uglify-es and uglify-js@3.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp dir=\"auto\"\u003e所以使用rollup-plugin-terser作为minify工具。\u003c/p\u003e"},"__N_SSG":true},"page":"/post/[id]","query":{"id":"5"},"buildId":"qyoq5YUbT8vkn4SeD-glR","assetPrefix":"/blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>